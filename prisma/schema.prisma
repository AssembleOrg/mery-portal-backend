// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  SUBADMIN
  USER
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole @default(USER)
  firstName String?
  lastName  String?
  phone     String?
  country   String?
  city      String?
  isActive  Boolean  @default(true)
  
  // Email verification
  isEmailVerified    Boolean   @default(false)
  emailVerificationToken String?
  emailVerificationExpires DateTime?
  lastVerificationEmailSent DateTime?
  
  // Password reset
  passwordResetToken String?
  passwordResetExpires DateTime?
  lastPasswordResetEmailSent DateTime?
  
  // Relations
  categoryPurchases CategoryPurchase[]
  videoViews        VideoView[]
  cart              Cart?
  presencialVotes   PresencialVote[]
  
  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  
  @@map("users")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String   // CREATE, UPDATE, DELETE, etc.
  entity    String   // Table name
  entityId  String   // Record ID
  oldValues Json?
  newValues Json?
  ipAddress String?
  location  String?
  userAgent String?
  
  createdAt DateTime @default(now())
  
  @@map("audit_logs")
}

model VideoCategory {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  description      String?
  long_description String?  @db.Text
  image            String?
  target           String?
  order            Int      @default(0)
  isActive         Boolean  @default(true)
  
  // Multilanguage fields (English versions)
  long_description_en String?  @db.Text
  target_en           String?
  
  // Course modality
  modalidad    String?
  modalidad_en String?
  
  // What students will learn
  learn    String?  @db.Text
  learn_en String?  @db.Text
  
  // What the course includes (structured data)
  includes_category    Json?
  includes_category_en Json?
    
  // Pricing (a nivel de curso/categor√≠a) - Dual currency
  priceARS         Decimal  @db.Decimal(10, 2)
  priceUSD         Decimal  @db.Decimal(10, 2)
  isFree           Boolean  @default(false)
  
  videos           Video[]
  purchases        CategoryPurchase[]
  cartItems        CartItem[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  deletedAt        DateTime?
  
  @@map("video_categories")
}

model Video {
  id              String        @id @default(cuid())
  title           String
  description     String?
  thumbnail       String?
  duration        Int?          // Duration in seconds
  
  // Vimeo Integration
  vimeoId         String
  vimeoUrl        String?
  
  // Organization
  categoryId      String
  category        VideoCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  order           Int           @default(0)
  
  // Status
  isPublished     Boolean       @default(false)
  publishedAt     DateTime?
  
  // Content
  contenidos      String?       @db.Text  // Video content/syllabus
  downloads       Json?                   // Downloadable resources
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  // Relations
  views           VideoView[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?
  
  @@map("videos")
}

model CategoryPurchase {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryId      String
  category        VideoCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  
  // Payment info
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("USD")
  paymentMethod   String?  // "credit_card", "paypal", etc.
  transactionId   String?  // External payment provider transaction ID
  paymentStatus   String   @default("completed") // "pending", "completed", "failed", "refunded"
  
  // Access control
  expiresAt       DateTime? // null = permanent access
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([userId, categoryId])
  @@index([transactionId])
  @@map("category_purchases")
}

model VideoView {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  videoId         String
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  // Analytics
  watchedSeconds  Int      @default(0)
  totalSeconds    Int?
  progress        Int      @default(0) // Percentage 0-100
  completed       Boolean  @default(false)
  
  // Session info
  ipAddress       String?
  userAgent       String?
  device          String?  // "desktop", "mobile", "tablet"
  
  lastWatchedAt   DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([userId, videoId])
  @@map("video_views")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  items     CartItem[]
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  @@map("carts")
}

model CartItem {
  id         String        @id @default(cuid())
  cartId     String
  cart       Cart          @relation(fields: [cartId], references: [id], onDelete: Cascade)
  categoryId String
  category   VideoCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  // Snapshot of prices at the time of adding to cart
  priceARS   Decimal       @db.Decimal(10, 2)
  priceUSD   Decimal       @db.Decimal(10, 2)
  
  addedAt    DateTime      @default(now())
  
  @@unique([cartId, categoryId])
  @@map("cart_items")
}

enum PresencialPollStatus {
  draft
  open
  closed
}

model PresencialPoll {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      PresencialPollStatus @default(draft)
  deadlineAt  DateTime?
  
  // Eligibility stored as JSON: { courseIds: string[], userOverrides: Array<{ userId?: string, email?: string, allowed: boolean }> }
  eligibility Json     @default("{\"courseIds\":[],\"userOverrides\":[]}")
  
  options     PresencialPollOption[]
  votes       PresencialVote[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status])
  @@map("presencial_polls")
}

model PresencialPollOption {
  id              String   @id @default(cuid())
  pollId          String
  poll            PresencialPoll @relation(fields: [pollId], references: [id], onDelete: Cascade)
  date            DateTime // Stored as date only (time will be ignored)
  startTime       String   // HH:mm format
  durationMinutes Int      @default(120)
  
  votes           PresencialVote[]
  
  createdAt       DateTime @default(now())
  
  @@map("presencial_poll_options")
}

model PresencialVote {
  id        String   @id @default(cuid())
  pollId    String
  poll      PresencialPoll @relation(fields: [pollId], references: [id], onDelete: Cascade)
  optionId  String
  option    PresencialPollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userName  String?
  votedAt   DateTime @default(now())
  
  @@unique([pollId, userId])
  @@index([pollId])
  @@index([optionId])
  @@map("presencial_votes")
}
